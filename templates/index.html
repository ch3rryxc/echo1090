<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0;
    display: flex;
    height: 100vh;
    font-family: 'Montserrat', sans-serif;
    background-color: #121212;
    color: #eee;
  }
  #map {
    flex: 3;
    height: 100%;
  }
  #sidebar {
    flex: 1;
    background: #1a1a1a;
    border-left: 1px solid #2c2c2c;
    overflow-y: auto;
    padding: 16px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  h2 {
    margin-top: 0;
    font-weight: 600;
    color: #fff;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
  }
  #flight-list {
    margin-top: 12px;
    flex-grow: 1;
  }
  .flight {
    background: #222;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .flight:hover {
    background: #2a2a2a;
  }
  .flight strong {
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
  }
  .flight img {
    margin-top: 8px;
    border-radius: 6px;
    width: 100%;
    height: auto;
    object-fit: contain;
    border: 1px solid #444;
  }
  .leaflet-popup-content-wrapper {
    background: #222;
    color: #eee;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.8);
  }
  .leaflet-popup-tip {
    background: #222;
  }
  .leaflet-tooltip {
    background: rgba(34, 34, 34, 0.9);
    color: #eee;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 13px;
    pointer-events: none;
    font-weight: 600;
    box-shadow: 0 0 5px rgba(0,0,0,0.7);
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h2>Flights</h2>
  <div id="flight-list"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map', {
    zoomControl: false
  }).setView([{{ lat }}, {{ lon }}], 9); 

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://carto.com/">CARTO</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  function createPlaneIcon(angle = 0) {
    return L.divIcon({
      className: '',
      html: `<img src="/static/plane.png" style="width:30px;height:30px;transform:rotate(${angle}deg);">`,
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -15]
    });
  }

  let markers = {};
  let trails = {};
  let positions = {};

  function fetchFlights() {
    fetch('/live')
      .then(res => res.json())
      .then(data => {
        updateMap(data);
        updateSidebar(data);
      })
      .catch(err => console.error('[ERROR] Failed to fetch data:', err));
  }

  function updateMap(flights) {
    const activeIds = new Set();

    flights.forEach(flight => {
      const id = flight.callsign;
      activeIds.add(id);

      if (!flight.pos || typeof flight.pos.lat !== 'number' || typeof flight.pos.lng !== 'number') return;

      const latlng = [flight.pos.lat, flight.pos.lng];
      const angle = flight.pos.hd || 0;
      const icon = createPlaneIcon(angle);

      positions[id] = positions[id] || [];
      const lastPos = positions[id][positions[id].length - 1];
      if (!lastPos || lastPos[0] !== latlng[0] || lastPos[1] !== latlng[1]) {
        positions[id].push(latlng);
        if (positions[id].length > 100) positions[id].shift();
      }

      if (markers[id]) {
        markers[id].setLatLng(latlng);
        markers[id].setIcon(icon);
        markers[id].getTooltip().setLatLng(latlng);
      } else {
        const marker = L.marker(latlng, { icon }).addTo(map);
        const tooltip = L.tooltip({
          permanent: true,
          direction: 'top',
          offset: [0, -20],
          className: 'leaflet-tooltip'
        }).setContent(flight.callsign);
        marker.bindTooltip(tooltip).openTooltip();
        marker.bindPopup(`
          <strong>${flight.callsign}</strong><br>
          ${flight.origin} - ${flight.destination}<br>
          Flight: ${flight.number}<br>
          Model: ${flight.model}<br>
          Registration: ${flight.reg}<br>
          Airline: ${flight.airline}<br>
          ${flight.image && flight.image.startsWith('http') ? `<img src="${flight.image}" width="200" style="margin-top:8px;border-radius:6px;">` : ''}
        `);
        markers[id] = marker;
      }

      if (trails[id]) {
        trails[id].setLatLngs(positions[id]);
      } else {
        trails[id] = L.polyline(positions[id], { color: '#00ff90', weight: 2, opacity: 0.8 }).addTo(map);
      }
    });

    for (const id in markers) {
      if (!activeIds.has(id)) {
        map.removeLayer(markers[id]);
        if (markers[id].getTooltip()) map.removeLayer(markers[id].getTooltip());
        delete markers[id];
      }
    }
    for (const id in trails) {
      if (!activeIds.has(id)) {
        map.removeLayer(trails[id]);
        delete trails[id];
        delete positions[id];
      }
    }
  }

  function updateSidebar(flights) {
    const list = document.getElementById('flight-list');
    list.innerHTML = '';
    flights.forEach(flight => {
      const div = document.createElement('div');
      div.className = 'flight';
      div.innerHTML = `
        <strong>${flight.callsign} (${flight.reg})</strong><br>
        ${flight.origin} - ${flight.destination}<br>
        Flight: ${flight.number}<br>
        Model: ${flight.model}<br>
        Airline: ${flight.airline}<br>
        ${flight.image && flight.image.startsWith('http') ? `<img src="${flight.image}" alt="Aircraft photo">` : ''}
      `;
      div.onclick = () => {
        if (markers[flight.callsign]) {
          markers[flight.callsign].openPopup();
          map.setView(markers[flight.callsign].getLatLng(), 8);
        }
      };
      list.appendChild(div);
    });
  }

  fetchFlights();
  setInterval(fetchFlights, 10000);
</script>
</body>
</html>
